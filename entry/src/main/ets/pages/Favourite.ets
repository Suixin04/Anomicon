import { AppStorageV2 } from "@kit.ArkUI"
import { FavoriteService } from '../common/service/FavoriteService'
import { FavoriteItem } from '../viewmodel/FavoriteItem'
import { promptAction } from '@kit.ArkUI'
import { SCP, Tale } from '../utils/types'

// æ”¶è—é¡µé¢ç»„ä»¶
@ComponentV2
export struct Favourite {
  // å¯¼èˆªè·¯å¾„æ ˆï¼Œç”¨äºé¡µé¢è·³è½¬
  @Local pathStack: NavPathStack = AppStorageV2.connect(NavPathStack, 'navStack', () => new NavPathStack())!
  // æ”¶è—åˆ—è¡¨
  @Local favoriteItems: FavoriteItem[] = []
  // åŠ è½½çŠ¶æ€
  @Local isLoading: boolean = true
  // å½“å‰é€‰æ‹©çš„ç±»å‹è¿‡æ»¤å™¨
  @Local selectedType: string = 'ALL' // 'ALL', 'SCP', 'TALE'

  // å–æ¶ˆæ”¶è—å˜æ›´è®¢é˜…çš„å‡½æ•°
  private unsubscribeFavoriteChange?: () => void;

  // é¡µé¢å³å°†æ˜¾ç¤ºï¼šåˆå§‹åŒ–æœåŠ¡å¹¶è®¢é˜…æ”¶è—å˜æ›´
  async aboutToAppear(): Promise<void> {
    // ç¡®ä¿æœåŠ¡å·²åˆå§‹åŒ–
    await FavoriteService.initialize(getContext(this));
    // åˆå§‹åŒ–å®ŒæˆååŠ è½½æ•°æ®
    await this.loadFavorites();
    // é˜²æ­¢é‡å¤è®¢é˜…
    this.unsubscribeFavoriteChange?.();
    this.unsubscribeFavoriteChange = FavoriteService.getInstance().addChangeListener(() => {
      // ä»»æ„é¡µé¢æ”¶è—çŠ¶æ€å˜æ›´æ—¶ï¼Œåˆ·æ–°å½“å‰åˆ—è¡¨
      this.loadFavorites();
    });
  }

  // é¡µé¢å°†è¢«é”€æ¯ï¼šå–æ¶ˆè®¢é˜…ï¼Œé¿å…å†…å­˜æ³„æ¼
  aboutToBeDeleted(): void {
    this.unsubscribeFavoriteChange?.();
    this.unsubscribeFavoriteChange = undefined;
  }

  // åŠ è½½æ”¶è—åˆ—è¡¨
  private async loadFavorites(): Promise<void> {
    this.isLoading = true;
    try {
      const service = FavoriteService.getInstance();
      if (this.selectedType === 'ALL') {
        this.favoriteItems = await service.getAllFavorites();
      } else {
        this.favoriteItems = await service.getFavoritesByType(this.selectedType);
      }
    } catch (error) {
      console.error('åŠ è½½æ”¶è—åˆ—è¡¨å¤±è´¥:', error);
      promptAction.showToast({
        message: 'åŠ è½½æ”¶è—åˆ—è¡¨å¤±è´¥'
      });
    } finally {
      this.isLoading = false;
    }
  }

  // åˆ é™¤æ”¶è—é¡¹
  private async removeFavorite(item: FavoriteItem): Promise<void> {
    try {
      const service = FavoriteService.getInstance();
      const success = await service.removeFromFavorites(item.scpId);
      if (success) {
        // ä»åˆ—è¡¨ä¸­ç§»é™¤
        const index = this.favoriteItems.findIndex(fav => fav.id === item.id);
        if (index !== -1) {
          this.favoriteItems.splice(index, 1);
        }
        promptAction.showToast({
          message: 'å·²å–æ¶ˆæ”¶è—'
        });
      } else {
        promptAction.showToast({
          message: 'å–æ¶ˆæ”¶è—å¤±è´¥'
        });
      }
    } catch (error) {
      console.error('åˆ é™¤æ”¶è—å¤±è´¥:', error);
      promptAction.showToast({
        message: 'å–æ¶ˆæ”¶è—å¤±è´¥'
      });
    }
  }

  // å¯¼èˆªåˆ°è¯¦æƒ…é¡µ
  private navigateToDetail(item: FavoriteItem): void {
    if (item.type === 'SCP') {
      // æ„é€ SCPå¯¹è±¡
      const scpItem: SCP = {
        id: item.scpId,
        number: item.scpId,
        title: item.title,
        objectClass: item.objectClass || '',
        description: item.description,
        containmentProcedures: '',
        series: 1,
        dateAdded: new Date().toISOString(),
        image: item.imageUrl,
        tags: [],
        isFavorited: true
      };
      this.pathStack.pushPathByName('scpObjDetail', scpItem, (_popInfo) => {
        this.loadFavorites();
      });
    } else if (item.type === 'TALE') {
      // æ„é€ Taleå¯¹è±¡
      const taleItem: Tale = {
        id: item.scpId,
        title: item.title,
        author: '',
        content: item.description,
        datePublished: new Date().toISOString(),
        tags: [],
        relatedSCPs: []
      };
      this.pathStack.pushPathByName('scpDocDetail', taleItem, (_popInfo) => {
        this.loadFavorites();
      });
    }
  }

  // æ„å»ºæ”¶è—é¡¹UI
  @Builder
  private buildFavoriteItem(item: FavoriteItem) {
    Row({ space: 15 }) {
      // å›¾ç‰‡æˆ–å›¾æ ‡
      if (item.imageUrl) {
        Image(item.imageUrl)
          .width(60)
          .height(60)
          .borderRadius(8)
          .objectFit(ImageFit.Cover)
      } else {
        Column() {
          Text(item.type === 'SCP' ? 'ğŸ“‹' : 'ğŸ“–')
            .fontSize(24)
        }
        .width(60)
        .height(60)
        .backgroundColor('#333')
        .borderRadius(8)
        .justifyContent(FlexAlign.Center)
      }

      // å†…å®¹ä¿¡æ¯
      Column({ space: 5 }) {
        // æ ‡é¢˜
        Text(item.title)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#fff')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .textAlign(TextAlign.Start)

        // ç±»å‹å’Œç­‰çº§
        Row({ space: 10 }) {
          Text(item.type === 'SCP' ? 'SCPé¡¹ç›®' : 'æ•…äº‹æ–‡æ¡£')
            .fontSize(12)
            .fontColor('#ff6b35')
            .backgroundColor('#ff6b3520')
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .borderRadius(4)

          if (item.objectClass) {
            Text(item.objectClass)
              .fontSize(12)
              .fontColor('#a0a0a0')
              .backgroundColor('#333')
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .borderRadius(4)
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)

        // æè¿°
        if (item.description) {
          Text(item.description)
            .fontSize(14)
            .fontColor('#a0a0a0')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('100%')
            .textAlign(TextAlign.Start)
        }

        // æ”¶è—æ—¶é—´
        Text(`æ”¶è—äº ${new Date(item.dateAdded).toLocaleDateString()}`)
          .fontSize(12)
          .fontColor('#666')
          .width('100%')
          .textAlign(TextAlign.Start)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // æ“ä½œæŒ‰é’®
      Column({ space: 10 }) {
        Button() {
          Image($r('app.media.heart_em'))
            .width(20)
            .height(20)
            .fillColor('#ff6b35')
        }
        .width(40)
        .height(40)
        .backgroundColor('#333')
        .borderRadius(20)
        .onClick(() => {
          this.removeFavorite(item);
        })
      }
    }
    .width('100%')
    .padding(15)
    .backgroundColor('#1e1e1e')
    .borderRadius(10)
    .border({ width: 0.5, color: '#ee717182' })
    .onClick(() => {
      this.navigateToDetail(item);
    })
  }

  // é¡µé¢æ˜¾ç¤ºæ—¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
  async onPageShow(): Promise<void> {
    console.info('Favouriteé¡µé¢æ˜¾ç¤ºï¼Œåˆ·æ–°æ”¶è—æ•°æ®');
    // ç¡®ä¿æœåŠ¡å·²åˆå§‹åŒ–ï¼ˆåº”å¯¹åº”ç”¨å†·å¯åŠ¨æƒ…å†µï¼‰
    await FavoriteService.initialize(getContext(this));
    // é¡µé¢æ¯æ¬¡æ˜¾ç¤ºæ—¶éƒ½åˆ·æ–°æ•°æ®ï¼ŒåŒ…æ‹¬åº”ç”¨é‡æ–°è¿›å…¥å‰å°
    await this.loadFavorites();
  }

  build() {
    Scroll() {
      Column({ space: 20 }) {
        // é¡µé¢æ ‡é¢˜
        Text('æˆ‘çš„æ”¶è—')
          .fontSize(25)
          .fontWeight(FontWeight.Medium)
          .fontColor('#fff')
          .margin({bottom: 20})

        // ç±»å‹è¿‡æ»¤å™¨
        Row({ space: 10 }) {
          Text('å…¨éƒ¨')
            .backgroundColor(this.selectedType === 'ALL' ? '#ff4444' : '#10717182')
            .fontColor(this.selectedType === 'ALL' ? '#000' : '#fff')
            .fontSize(14)
            .border({radius: 8, width: this.selectedType === 'ALL' ? 0 : 0.5, color: '#ee717182'})
            .padding({ left: 13, right: 13, top: 8, bottom: 8 })
            .onClick(() => {
              this.selectedType = 'ALL';
              this.loadFavorites();
            })
          Text('SCPé¡¹ç›®')
            .backgroundColor(this.selectedType === 'SCP' ? '#ff4444' : '#10717182')
            .fontColor(this.selectedType === 'SCP' ? '#000' : '#fff')
            .fontSize(14)
            .border({radius: 8, width: this.selectedType === 'SCP' ? 0 : 0.5, color: '#ee717182'})
            .padding({ left: 13, right: 13, top: 8, bottom: 8 })
            .onClick(() => {
              this.selectedType = 'SCP';
              this.loadFavorites();
            })
          Text('æ•…äº‹æ–‡æ¡£')
            .backgroundColor(this.selectedType === 'TALE' ? '#ff4444' : '#10717182')
            .fontColor(this.selectedType === 'TALE' ? '#000' : '#fff')
            .fontSize(14)
            .border({radius: 8, width: this.selectedType === 'TALE' ? 0 : 0.5, color: '#ee717182'})
            .padding({ left: 13, right: 13, top: 8, bottom: 8 })
            .onClick(() => {
              this.selectedType = 'TALE';
              this.loadFavorites();
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)
        .margin({bottom: 20})

        // åŠ è½½çŠ¶æ€
        if (this.isLoading) {
          Column({ space: 15 }) {
            LoadingProgress()
              .width(50)
              .height(50)
              .color('#ff6b35')
            Text('åŠ è½½ä¸­...')
              .fontSize(16)
              .fontColor('#a0a0a0')
          }
          .width('100%')
          .height(200)
          .justifyContent(FlexAlign.Center)
        }
        // æ”¶è—åˆ—è¡¨
        else if (this.favoriteItems.length > 0) {
          Column({ space: 15 }) {
            ForEach(this.favoriteItems, (item: FavoriteItem) => {
              this.buildFavoriteItem(item)
            })
          }
          .width('100%')
        }
        // ç©ºæ”¶è—æç¤º
        else {
          Column({ space: 15 }) {
            Text('ğŸ’')
              .fontSize(50)
            Text('æš‚æ— æ”¶è—')
              .fontSize(18)
              .fontColor('#fff')
              .fontWeight(FontWeight.Bold)
            Text('æµè§ˆSCPæ¡£æ¡ˆå¹¶ç‚¹å‡»â¤ï¸æ¥æ·»åŠ åˆ°æ”¶è—å¤¹')
              .fontSize(14)
              .fontColor('#a0a0a0')
          }
          .border({width: 0.5, color: '#ee717182', radius: 10})
          .width('100%')
          .backgroundColor('#1e1e1e')
          .padding({left: 20, right: 20, top: 50, bottom: 50})
        }
      }
      .padding({left: 25, right: 25})
      .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP])
      .height('100%')
      .width('100%')
    }
    .scrollable(ScrollDirection.Vertical)
    .scrollBar(BarState.Off)
    .height('100%')
    .width('100%')
    .onAppear(async () => {
      // é¡µé¢å‡ºç°æ—¶ç¡®ä¿æœåŠ¡å·²åˆå§‹åŒ–
      await FavoriteService.initialize(getContext(this));
      // åŠ è½½æ•°æ®
      await this.loadFavorites();
    })
  }
}