import { AppStorageV2, PromptAction, promptAction } from "@kit.ArkUI"
import { FavoriteItem, FavoriteService, FontSizeManager, getColorsByClass, SCP,
  scpApi,
  Tale, VibrationUtils } from "utils"
import { CustomButtonView, Title } from "uicomponents"

@ComponentV2
export struct Favourite {
  /** å¯¼èˆªè·¯å¾„æ ˆï¼Œç”¨äºé¡µé¢é—´çš„å¯¼èˆªç®¡ç† */
  @Consumer('pageStack')pageStack?: NavPathStack
  /** æ”¶è—é¡¹ç›®åˆ—è¡¨ï¼ŒåŒ…å«SCPé¡¹ç›®å’Œæ•…äº‹ */
  @Local favoriteItems: FavoriteItem[] = []
  /** æ•°æ®åŠ è½½çŠ¶æ€ */
  @Local isLoading: boolean = true
  /** å½“å‰é€‰æ‹©çš„ç±»å‹è¿‡æ»¤å™¨ï¼š'ALL'(å…¨éƒ¨)ã€'SCP'(SCPé¡¹ç›®)ã€'TALE'(æ•…äº‹) */
  @Local selectedType: string = 'ALL' // 'ALL', 'SCP', 'TALE'
  /** æ»šåŠ¨æ§åˆ¶å™¨ */
  private scroller: Scroller = new Scroller()
  /** å–æ¶ˆæ”¶è—å˜æ›´è®¢é˜…çš„å‡½æ•°ï¼Œç”¨äºé¿å…å†…å­˜æ³„æ¼ */
  private unsubscribeFavoriteChange?: () => void;

  private promptAction: PromptAction | undefined;

  /**
   * é¡µé¢å³å°†æ˜¾ç¤ºç”Ÿå‘½å‘¨æœŸæ–¹æ³•
   * åˆå§‹åŒ–æ”¶è—æœåŠ¡å¹¶è®¢é˜…æ”¶è—å˜æ›´äº‹ä»¶
   */
  async aboutToAppear(): Promise<void> {
    // è·å–å½“å‰ UI ä¸Šä¸‹æ–‡çš„ PromptAction å®ä¾‹
    this.promptAction = this.getUIContext().getPromptAction();
    // ç¡®ä¿æœåŠ¡å·²åˆå§‹åŒ–
    await FavoriteService.initialize(getContext(this));
    // åˆå§‹åŒ–å®ŒæˆååŠ è½½æ•°æ®
    await this.loadFavorites();
    // é˜²æ­¢é‡å¤è®¢é˜…
    this.unsubscribeFavoriteChange?.();
    this.unsubscribeFavoriteChange = FavoriteService.getInstance().addChangeListener(() => {
      // ä»»æ„é¡µé¢æ”¶è—çŠ¶æ€å˜æ›´æ—¶ï¼Œåˆ·æ–°å½“å‰åˆ—è¡¨
      this.loadFavorites();
    });
  }

  /**
   * é¡µé¢å°†è¢«é”€æ¯ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
   * å–æ¶ˆè®¢é˜…æ”¶è—å˜æ›´äº‹ä»¶ï¼Œé¿å…å†…å­˜æ³„æ¼
   */
  aboutToBeDeleted(): void {
    this.unsubscribeFavoriteChange?.();
    this.unsubscribeFavoriteChange = undefined;
  }

  /**
   * é¡µé¢æ˜¾ç¤ºæ—¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
   * ç¡®ä¿æœåŠ¡å·²åˆå§‹åŒ–å¹¶åˆ·æ–°æ”¶è—æ•°æ®
   */
  async onPageShow(): Promise<void> {
    console.info('Favouriteé¡µé¢æ˜¾ç¤ºï¼Œåˆ·æ–°æ”¶è—æ•°æ®');
    // ç¡®ä¿æœåŠ¡å·²åˆå§‹åŒ–ï¼ˆåº”å¯¹åº”ç”¨å†·å¯åŠ¨æƒ…å†µï¼‰
    await FavoriteService.initialize(getContext(this));
    // é¡µé¢æ¯æ¬¡æ˜¾ç¤ºæ—¶éƒ½åˆ·æ–°æ•°æ®ï¼ŒåŒ…æ‹¬åº”ç”¨é‡æ–°è¿›å…¥å‰å°
    await this.loadFavorites();
  }

  build() {
    Column() {
      Title({ str: "æˆ‘çš„æ”¶è—", scroller: this.scroller })

      Scroll(this.scroller) {
        Column({ space: 20 }) {

          // ç±»å‹è¿‡æ»¤å™¨
          Row({ space: 10 }) {
            CustomButtonView({ text: 'å…¨éƒ¨', isSelected: this.selectedType === 'ALL' ? true : false })
              .onClick(() => {
                VibrationUtils.lightTap()
                this.selectedType = 'ALL';
                this.loadFavorites();
              })
            CustomButtonView({ text: 'SCPé¡¹ç›®', isSelected: this.selectedType === 'SCP' ? true : false })
              .onClick(() => {
                VibrationUtils.lightTap()
                this.selectedType = 'SCP';
                this.loadFavorites();
              })
            CustomButtonView({ text: 'æ•…äº‹æ–‡æ¡£', isSelected: this.selectedType === 'TALE' ? true : false })
              .onClick(() => {
                VibrationUtils.lightTap()
                this.selectedType = 'TALE';
                this.loadFavorites();
              })
          }
          .width('100%')
          .justifyContent(FlexAlign.Start)
          .margin({ bottom: 20 })

          // åŠ è½½çŠ¶æ€
          if (this.isLoading) {
            Column({ space: 15 }) {
              LoadingProgress()
                .width(50)
                .height(50)
                .color($r('app.color.tag_orange_text'))
              Text('åŠ è½½ä¸­...')
                .fontSize(FontSizeManager.getScaledFontSize(16))
                .fontColor($r('app.color.text_secondary'))
            }
            .width('100%')
            .height(200)
            .justifyContent(FlexAlign.Center)
          }
          // æ”¶è—åˆ—è¡¨
          else if (this.favoriteItems.length > 0) {
            Column({ space: 15 }) {
              ForEach(this.favoriteItems, (item: FavoriteItem) => {
                this.buildFavoriteItem(item)
              })
            }
            .width('100%')
          }
          // ç©ºæ”¶è—æç¤º
          else {
            Column({ space: 15 }) {
              Text('ğŸ’')
                .fontSize(FontSizeManager.getScaledFontSize(50))
              Text('æš‚æ— æ”¶è—')
                .fontSize(FontSizeManager.getScaledFontSize(18))
                .fontColor($r('app.color.text_primary'))
                .fontWeight(FontWeight.Bold)
              Text('æµè§ˆSCPæ¡£æ¡ˆå¹¶ç‚¹å‡»â¤ï¸æ¥æ·»åŠ åˆ°æ”¶è—å¤¹')
                .fontSize(FontSizeManager.getScaledFontSize(14))
                .fontColor($r('app.color.text_secondary'))
            }
            .border({ width: 0.5, color: $r('app.color.border_primary'), radius: 10 })
            .width('100%')
            .backgroundColor($r('app.color.background_secondary'))
            .padding({
              left: 20,
              right: 20,
              top: 50,
              bottom: 50
            })
          }
        }
        .padding({ left: 25, right: 25, bottom: 25 })
        .width('100%')
        // .height('100%')
      }
      .align(Alignment.Top)
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Off)
      .layoutWeight(1)
      .width('100%')
      .onAppear(async () => {
        // é¡µé¢å‡ºç°æ—¶ç¡®ä¿æœåŠ¡å·²åˆå§‹åŒ–
        await FavoriteService.initialize(getContext(this));
        // åŠ è½½æ•°æ®
        await this.loadFavorites();
      })
    }
    // .height('100%')
    .width('100%')
  }

  /**
   * åŠ è½½æ”¶è—åˆ—è¡¨æ•°æ®
   * æ ¹æ®å½“å‰é€‰æ‹©çš„ç±»å‹è¿‡æ»¤å™¨ä»æ”¶è—æœåŠ¡ä¸­è·å–ç›¸åº”çš„æ”¶è—é¡¹ç›®
   */
  private async loadFavorites(): Promise<void> {
    this.isLoading = true;
    try {
      const service = FavoriteService.getInstance();
      if (this.selectedType === 'ALL') {
        this.favoriteItems = await service.getAllFavorites();
      } else {
        this.favoriteItems = await service.getFavoritesByType(this.selectedType);
      }
    } catch (error) {
      console.error('åŠ è½½æ”¶è—åˆ—è¡¨å¤±è´¥:', error);
      this.promptAction?.showToast({
        message: 'åŠ è½½æ”¶è—åˆ—è¡¨å¤±è´¥'
      });
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * åˆ é™¤æ”¶è—é¡¹
   * @param item è¦åˆ é™¤çš„æ”¶è—é¡¹
   */
  private async removeFavorite(item: FavoriteItem): Promise<void> {
    try {
      const service = FavoriteService.getInstance();
      const success = await service.removeFromFavorites(item.scpId);
      if (success) {
        // ä»åˆ—è¡¨ä¸­ç§»é™¤
        const index = this.favoriteItems.findIndex(fav => fav.id === item.id);
        if (index !== -1) {
          this.favoriteItems.splice(index, 1);
        }
        this.promptAction?.showToast({
          message: 'å·²å–æ¶ˆæ”¶è—'
        });
      } else {
        this.promptAction?.showToast({
          message: 'å–æ¶ˆæ”¶è—å¤±è´¥'
        });
      }
    } catch (error) {
      console.error('åˆ é™¤æ”¶è—å¤±è´¥:', error);
      this.promptAction?.showToast({
        message: 'å–æ¶ˆæ”¶è—å¤±è´¥'
      });
    }
  }

  /**
   * å¯¼èˆªåˆ°è¯¦æƒ…é¡µé¢
   * æ ¹æ®é¡¹ç›®ç±»å‹è·³è½¬åˆ°ç›¸åº”çš„è¯¦æƒ…é¡µ
   * @param item è¦æŸ¥çœ‹è¯¦æƒ…çš„æ”¶è—é¡¹ç›®
   */
  private async navigateToDetail(item: FavoriteItem): Promise<void> {
    if (item.type === 'SCP') {
      // æ„é€ SCPå¯¹è±¡
      const instance = await scpApi.getScpDetail(item.scpId)
      this.pageStack!.pushPathByName('objDetailPage', instance, false);
    } else if (item.type === 'TALE') {
      // æ„é€ Taleå¯¹è±¡
      const taleItem: Tale = {
        id: item.scpId,
        title: item.title,
        author: '',
        content: item.description,
        datePublished: new Date().toISOString(),
        tags: [],
        relatedSCPs: []
      };
      this.pageStack!.pushPathByName('taleDetailPage', taleItem, false);
    }
  }

  /**
   * æ„å»ºæ”¶è—é¡¹UIç»„ä»¶
   * @param item æ”¶è—é¡¹æ•°æ®
   */
  @Builder
  private buildFavoriteItem(item: FavoriteItem) {
    Row({ space: 15 }) {
      // å›¾ç‰‡æˆ–å›¾æ ‡
      if (item.imageUrl) {
        Image(item.imageUrl)
          .width(60)
          .height(60)
          .borderRadius(8)
          .objectFit(ImageFit.Cover)
      } else {
        Column() {
          Text(item.type === 'SCP' ? 'ğŸ“‹' : 'ğŸ“–')
            .fontSize(FontSizeManager.getScaledFontSize(24))
        }
        .width(60)
        .height(60)
        .backgroundColor($r('app.color.border_secondary'))
        .borderRadius(8)
        .justifyContent(FlexAlign.Center)
      }

      // å†…å®¹ä¿¡æ¯
      Column({ space: 5 }) {
        // æ ‡é¢˜
        Text(item.title)
          .fontSize(FontSizeManager.getScaledFontSize(16))
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .textAlign(TextAlign.Start)

        // ç±»å‹å’Œç­‰çº§
        Row({ space: 10 }) {
          Text(item.type === 'SCP' ? 'SCPé¡¹ç›®' : 'æ•…äº‹æ–‡æ¡£')
            .fontSize(FontSizeManager.getScaledFontSize(12))
            .fontColor($r('app.color.tag_orange_text'))
            .backgroundColor($r('app.color.tag_orange_bg'))
            .padding({
              left: 8,
              right: 8,
              top: 2,
              bottom: 2
            })
            .borderRadius(4)

          Blank()
            .layoutWeight(1)

          if (item.objectClass) {
            Text(item.objectClass)
              .border({ radius: 5, width: 0.8, color: getColorsByClass(item.objectClass).borderColor })
              .fontWeight(FontWeight.Bold)
              .fontColor(getColorsByClass(item.objectClass).textColor)
              .backgroundColor(getColorsByClass(item.objectClass).backgroundColor)
              .fontSize(FontSizeManager.getScaledFontSize(12))
              .padding({
                top: 3,
                bottom: 3,
                left: 6,
                right: 6
              })
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .backgroundColor($r('app.color.border_secondary'))
              .padding({
                left: 8,
                right: 8,
                top: 2,
                bottom: 2
              })
              .borderRadius(4)
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)

        // æè¿°
        if (item.description) {
          Text(item.description)
            .fontSize(FontSizeManager.getScaledFontSize(14))
            .fontColor($r('app.color.text_secondary'))
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('100%')
            .textAlign(TextAlign.Start)
        }

        // æ”¶è—æ—¶é—´
        Text(`æ”¶è—äº ${new Date(item.dateAdded).toLocaleDateString()}`)
          .fontSize(FontSizeManager.getScaledFontSize(12))
          .fontColor($r('app.color.text_tertiary'))
          .width('100%')
          .textAlign(TextAlign.Start)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // æ“ä½œæŒ‰é’®
      Column({ space: 10 }) {
        Button() {
          Image($r('app.media.heart_fill'))
            .width(20)
            .height(20)
            .fillColor($r('app.color.tag_orange_text'))
        }
        .width(40)
        .height(40)
        .backgroundColor($r('app.color.border_secondary'))
        .borderRadius(20)
        .onClick(() => {
          // æ·»åŠ è½»è§¦æŒ¯åŠ¨åé¦ˆ
          VibrationUtils.lightTap()
          this.removeFavorite(item);
        })
      }
    }
    .width('100%')
    .padding(15)
    .backgroundColor($r('app.color.background_secondary'))
    .borderRadius(10)
    .border({ width: 0.5, color: $r('app.color.border_primary') })
    .onClick(() => {
      VibrationUtils.lightTap()
      this.navigateToDetail(item);
    })
  }
}